generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model User {
  id            String   @id @default(cuid())
  firebaseUid   String   @unique
  email         String   @unique
  status        UserStatus @default(PENDING)
  role          UserRole   @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  organizationProfile OrganizationProfile?
  profilePic    ProfilePic?
  

  @@index([role])
  @@index([status])
  @@index([role, status])
}

model OrganizationProfile{
  id            String @id @default(cuid())
  userId        String @unique
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  orgName       String
  status        OrgStatus @default(PENDING)
  locationId    String
  location      Location @relation(fields: [locationId], references: [id])
  socials       OrgSocial?
  proofs        OrgProofFile[]
  events        Event[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
}

model OrgSocial{
  id                String @id @default(cuid())
  organizationId    String @unique
  organization      OrganizationProfile @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  instagramHandle String?
  facebookHandle  String?
  xHandle         String?
  otherText       String?
}

model OrgProofFile {
  id             String @id @default(cuid())
  organizationId String
  organization   OrganizationProfile @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platform       ProofPlatform
  imageAssetId   String
  imageAsset     ImageAsset @relation(fields: [imageAssetId], references: [id])

  createdAt      DateTime @default(now())
  @@index([organizationId])
}

model ProfilePic{
  id            String @id @default(cuid())
  userId        String @unique
  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)
  imageAssetId  String @unique
  imageAsset    ImageAsset @relation(fields: [imageAssetId], references: [id])

  @@index([userId])
}


model Event{
  id                String @id @default(cuid())
  organizationId    String 
  organization      OrganizationProfile @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  status            EventStatus @default(DRAFT)
  publishedAt       DateTime?
  title             String
  description       String
  ageRestriction    AgeRestriction @default(ALL_AGES)

  imageId           String?
  image             ImageAsset? @relation(fields: [imageId], references: [id])

  startsAtUTC       DateTime
  endsAtUTC         DateTime?
  timezone          String

  locationId        String?
  location          Location? @relation(fields: [locationId], references: [id])

  pricingType       EventPricingType
  minPriceCents     Int?
  maxPriceCents     Int?
  currency          String @default("CAD")

  tags              String[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([startsAtUTC])
  @@index([organizationId])
  @@index([tags], type: Gin)
}


model Tag{
  id          String @id @default(cuid())
  label       String @unique
  usageCount  Int @default(0)
  createdAt   DateTime @default(now())
}


model ImageAsset{
  id             String  @id @default(cuid())
  storagePath    String
  contentType    String?
  sizeBytes      Int?
  originalName   String?
  createdAt      DateTime @default(now())

  orgProofFiles OrgProofFile[]
  profilePics   ProfilePic[]
  events        Event[]
}

model Location{
  id          String @id @default(cuid())
  placeId     String @unique
  address     String?
  point     Unsupported("geography(Point, 4326)")
  createdAt DateTime @default(now())
  organizationProfiles OrganizationProfile[]
  events  Event[]

  @@index([point], type: Gist)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}


enum AgeRestriction {
  ALL_AGES
  AGE_18_PLUS
  AGE_19_PLUS
  AGE_21_PLUS
  AGE_65_PLUS
}

enum EventStatus {
  DRAFT
  PUBLISHED
}

enum EventPricingType {
  FREE
  FIXED
  RANGE
}

enum UserStatus {
  PENDING   // Signed up but email not verified
  ACTIVE    // Email verified, allowed to log in
  SUSPENDED // Admin action later
}

enum OrgStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum UserRole {
  USER
  ADMIN
  ORG
}

enum ProofPlatform {
  INSTAGRAM
  FACEBOOK
  X
  OTHER
}

enum EventCategory {
  SOCIAL
  NIGHTLIFE
  CULTURE_ARTS
  WELLNESS
  ADVOCACY_EDUCATION
  OTHER
}
