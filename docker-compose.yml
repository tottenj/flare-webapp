version: "3.9"

services:
  firebase:
    build:
      context: .
      dockerfile: docker/Dockerfile.firebase
    volumes:
      - ./localTest:/srv/firebase/localTest
    ports:
      - "8080:8080"   # Firestore emulator
      - "9099:9099"   # Auth emulator
      - "9199:9199"   # Storage emulator
      - "4000:4000"   # Emulator UI (optional)
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000 || exit 1"]
      interval: 5s
      timeout: 2s
      retries: 12

  app:
    build:
      context: .
      dockerfile: docker/Dockerfile.app
      args:
        NEXT_PUBLIC_FIRESTORE_EMULATOR_HOST: "firebase:8080"
        NEXT_PUBLIC_FIREBASE_AUTH_EMULATOR_HOST: "http://firebase:9099"
        NEXT_PUBLIC_STORAGE_EMULATOR_HOST: "firebase:9199"
        NEXT_PUBLIC_MODE: "test"
        NEXT_PUBLIC_FIREBASE_API_KEY: "AIzaSyDj5h2HzdQYuOzV_UVTHiwx1golUW93INU"
        NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: "flare-7091a.firebaseapp.com"
        NEXT_PUBLIC_FIREBASE_PROJECT_ID: "flare-7091a"
        NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: "flare-7091a.firebasestorage.app"
        NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: "192465328955"
        NEXT_PUBLIC_FIREBASE_APP_ID: "1:192465328955:web:108bbe86f58f4bbcb2f51e"
        NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: "G-JR9NDGTPV9"
        NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: "AIzaSyCJdJxUwxSxwu7sjCJobfmdx_R1Zs6fzbg"
    ports:
      - "3000:3000"
    depends_on:
      firebase:
        condition: service_healthy
    environment:
      NODE_ENV: production

  cypress:
    image: cypress/included:13.13.0
    working_dir: /e2e
    user: root
    volumes:
      - ./:/e2e
      - /e2e/node_modules
      - ./cypress/videos:/e2e/cypress/videos
      - ./cypress/screenshots:/e2e/cypress/screenshots
    depends_on:
      - firebase
      - app
    environment:
      CYPRESS_baseUrl: "http://app:3000"
      FIRESTORE_EMULATOR_HOST: "firebase:8080"
      FIREBASE_AUTH_EMULATOR_HOST: "http://firebase:9099"
      STORAGE_EMULATOR_HOST: "firebase:9199"
    entrypoint: ["bash", "-lc"]
    command: >
      "npm ci && npx wait-on http://app:3000 && npx cypress run --config baseUrl=http://app:3000"
