default:
  image: registry.gitlab.com/tottenj/flare-webapp/flare-ci:latest

stages:
  - test
  - cypress
  - chromatic

variables:
  NODE_VERSION: '22.12.0'
  FIREBASE_PROJECT_ID: 'flare-7091a' # Add your Firebase project ID

cache:
  key: ${CI_COMMIT_REF_SLUG} # or use "node-modules" if you want to share across branches
  paths:
    - node_modules/

before_script:
  - apt-get update -y
  - apt-get install -y openjdk-17-jdk
  - java -version
  - npm ci

jest:
  stage: test
  # Regex to extract code coverage percentage from Jest output
  coverage: /All files[^|]*\|[^|]*\s+([\d.]+)%/
  script:
    - npm test -- --coverage
    # Upload to Codecov using the official bash uploader
    - curl -s https://codecov.io/bash | bash -s -- -t $CODECOV_TOKEN -f coverage/lcov.info
  artifacts:
    paths:
      - coverage/lcov.info
      - coverage/
    expire_in: 1 week
  only:
    - branches
    - merge_requests

cypress:
  image: registry.gitlab.com/tottenj/flare-webapp/cypress-firebase:latest
  stage: cypress
  services:
    - name: docker:dind
  variables:
    CYPRESS_FIREBASE_WEB_API_KEY: $FIREBASE_API_KEY
    FIREBASE_AUTH_EMULATOR_HOST: 'localhost:9099'
  script:
    - export NEXT_PUBLIC_FIREBASE_API_KEY=$FIREBASE_API_KEY
    - export NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=flare-7091a.firebaseapp.com
    - export NEXT_PUBLIC_FIREBASE_PROJECT_ID=$FIREBASE_PROJECT_ID

    # Build your Next.js app for production output
    - npm run build

    # Run Firebase emulators and inside that run your static server and Cypress tests
    - firebase emulators:exec --only auth,firestore --project=$FIREBASE_PROJECT_ID "
        npx serve out & \
        npx cypress run --browser chrome --env FIREBASE_PROJECT_ID=$FIREBASE_PROJECT_ID,FIREBASE_WEB_API_KEY=$CYPRESS_FIREBASE_WEB_API_KEY
      "

chromatic:
  stage: chromatic
  script:
    - npx chromatic --project-token=$CHROMATIC_PROJECT_TOKEN
  only:
    - branches
    - merge_requests
