stages:
  - test
  - deploy

variables:
  NODE_VERSION: '22.12.0'
  FIREBASE_PROJECT_ID: 'flare-7091a'

# ----------------------------
# Jest job (fast, lightweight)
# ----------------------------
jest:
  stage: test
  image: node:22.12.0
  cache:
    key: "npm-cache"
    paths:
      - .npm
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - npm test -- --coverage
    - curl -s https://codecov.io/bash | bash -s -- -t $CODECOV_TOKEN -f coverage/lcov.info
  artifacts:
    when: always
    paths:
      - coverage/
      - reports/jest/junit.xml
    reports:
      junit: reports/jest/junit.xml
    expire_in: 1 week
  only:
    - branches
    - merge_requests

cypress:
  stage: test
  image: cypress/browsers:22.15.0
  cache:
    key: "npm-cache"
    paths:
      - .npm
      - /root/.cache/firebase/emulators   # cache Firebase emulator binaries
  variables:
    FIREBASE_API_KEY: $FIREBASE_API_KEY
    NEXT_PUBLIC_MODE: "test"
    MODE: "test"
    FIRESTORE_EMULATOR_HOST: 127.0.0.1:8080
    STORAGE_EMULATOR_HOST: 127.0.0.1:9199
    FIREBASE_AUTH_EMULATOR_HOST: 127.0.0.1:9099
  before_script:
    - apt-get update && apt-get install -y openjdk-17-jre netcat-openbsd curl
    - npm install -g firebase-tools
    - npm ci --cache .npm --prefer-offline
    - export NEXT_PUBLIC_FIREBASE_API_KEY=$FIREBASE_API_KEY
    - export NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=flare-7091a.firebaseapp.com
    - export NEXT_PUBLIC_FIREBASE_PROJECT_ID=flare-7091a
  script:
    # Start Firebase emulators in the background
    - firebase emulators:start --only firestore,auth,storage &

    # Wait for emulators to start
    - echo "Waiting for Firebase emulators..."
    - timeout 60 bash -c 'until nc -z 127.0.0.1 8080 && nc -z 127.0.0.1 9099 && nc -z 127.0.0.1 9199; do sleep 1; done;'

    # Start Next.js app in background
    - npm run dev &

    # Wait for Next.js app to be ready
    - npx wait-on http://localhost:3000

    # Run Cypress tests
    - npx cypress run --browser chrome --env FIREBASE_PROJECT_ID=$FIREBASE_PROJECT_ID,FIREBASE_WEB_API_KEY=$CYPRESS_FIREBASE_WEB_API_KEY
  artifacts:
    when: always
    paths:
      - reports/cypress/
    reports:
      junit: reports/cypress/*.xml
    expire_in: 1 week
  only:
    - branches
    - merge_requests
