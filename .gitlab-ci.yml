stages:
  - test
  - cypress
  - chromatic

variables:
  NODE_VERSION: '22.12.0'
  FIREBASE_PROJECT_ID: 'flare-7091a'
  CYPRESS_BASE_URL: 'https://localhost:3000'
  FIREBASE_API_KEY: 'AIzaSyDj5h2HzdQYuOzV_UVTHiwx1golUW93INU'

before_script:
  - apt-get update -y
  - DEBIAN_FRONTEND=noninteractive apt-get install -y \
      curl git openjdk-17-jre xvfb \
      libgtk-3-0 libnotify-dev libgconf-2-4 libnss3 \
      libxss1 libasound2 libxtst6 libx11-xcb1 libdrm2 \
      libgbm1 libxcomposite1 libxdamage1 libxrandr2 \
      libpango-1.0-0 libatk1.0-0 libcups2 libxinerama1
  - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  - apt-get install -y nodejs
  - node -v
  - npm ci
  - npm install -g firebase-tools

jest:
  stage: test
  coverage: /All files[^|]*\|[^|]*\s+([\d.]+)%/
  script:
    - npm test -- --coverage
    - curl -s https://codecov.io/bash | bash -s -- -t $CODECOV_TOKEN -f coverage/lcov.info
  artifacts:
    paths:
      - coverage/lcov.info
      - coverage/
    expire_in: 1 week
  only:
    - branches
    - merge_requests

cypress:
  stage: cypress
  script:
    - export DISPLAY=:99
    - Xvfb :99 -screen 0 1280x1024x24 > /dev/null 2>&1 &
    - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64

    # Start Firebase emulators
    - firebase emulators:start --project $FIREBASE_PROJECT_ID --only auth,firestore > /dev/null 2>&1 &

    # Start Next.js dev server with HTTPS (you must configure this in your project)
    - npm run dev &

    # Wait for app and emulators
    - npx wait-on -t 30000 https://localhost:3000 http://localhost:9099

    - npm run cypress:run

    # Stop background processes
    - pkill -f "firebase emulators"
    - pkill -f "next dev"
  artifacts:
    when: always
    paths:
      - cypress/screenshots/
      - cypress/videos/
    expire_in: 1 week
  only:
    - branches
    - merge_requests

chromatic:
  stage: chromatic
  script:
    - npx chromatic --project-token=$CHROMATIC_PROJECT_TOKEN
  only:
    - branches
    - merge_requests
